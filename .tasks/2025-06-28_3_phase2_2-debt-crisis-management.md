# Task Context
- Task_File_Name: 2025-06-28_3_phase2_2-debt-crisis-management.md
- Created_At: 2025-06-28_15:30:00
- Created_By: Ignorant-lu
- Associated_Protocol: 整合式RIPER-5多维思维与智能体执行协议 (条件化交互式步骤审查增强版) v6
- Main_Branch_Target: main
- Feature_Branch: feature/phase2.2-debt-crisis-management
- Related_Plan.md_Milestone(s): Phase 2.2: 债务危机管理与核心功能闭环
- AI_Confidence_Level (Initial, from Mode 0/1): High
- Focus_Level: [深度钻研 (Deep Dive)]

# Original User Task Description (or Scope Definition from Mode 0)
按照v8.1项目发展蓝图，正式启动Phase 2.2债务危机管理与核心功能闭环。通过一个为期4周的、高度集中的Sprint，全面偿还关键技术债务，补全核心功能。启动"债务危机管理"模式，将项目健康度从"临界状态"（94%债务信用额度）恢复到安全水平，确保产品的核心CRUD功能完整可用。采用"混合策略"，将v3.0的生态思路与v2.0的风险控制机制相结合。

# Non-Functional Requirements (NFRs) for this task
- **债务控制目标**: 将技术债务从47个降至30个以下（70%信用额度）
- **功能完整性**: 所有核心CRUD功能必须100%可用，无"待实现"占位符
- **数据持久化**: 用户数据必须可靠存储到SQLite数据库，重启应用不丢失
- **国际化支持**: 中英文语言切换功能必须正常工作
- **代码质量**: 新增代码必须通过flutter analyze检查，测试覆盖率≥80%
- **用户体验**: 编辑功能必须支持标题、内容、标签等属性的完整修改

---
*The following sections are maintained by the AI during protocol execution.*
---

# 1. Analysis (Populated by RESEARCH mode)
基于Phase 2.1技术债务审查，发现47个TODO项目，债务信用额度使用率达94%临界状态。其中6个"编辑功能待实现"占位符严重影响应用基本可用性，用户无法编辑任何已创建的内容。关键影响文件包括：workshop_widget.dart、responsive_web_shell.dart、modular_mobile_shell.dart、app_shell.dart、app_router.dart、app_localizations_zh.dart。同时发现i18n系统在Phase 2.0中被临时简化，导致动态语言切换功能缺失。数据持久化仍使用InMemoryRepository，数据重启后丢失。必须立即进入债务危机管理模式，优先修复P0级关键缺陷。

# 2. Proposed Solution(s) (Populated by INNOVATE mode)
采用v8.1债务危机管理策略，通过4周Sprint分阶段偿还债务：Sprint 1专注P0关键缺陷修复（编辑功能、设置页面导航）；Sprint 2建设核心服务（Drift数据库、i18n重建）；Sprint 3处理高优债务（DX工具链、性能优化）；Sprint 4质量保障与验证。此方案平衡了紧急性和可持续性，确保关键功能快速恢复的同时建立长期稳定的技术基础。

# 3. Implementation Plan (Generated by PLAN mode)

## Implementation Checklist:

### Phase A: Sprint 1 (Week 1) - 关键业务缺陷修复 (P0)
1. **[修复编辑功能完全缺失]** 实现所有业务模块的完整编辑功能，移除"编辑功能待实现"占位符。影响文件：workshop_widget.dart、responsive_web_shell.dart、modular_mobile_shell.dart、app_shell.dart、app_router.dart、app_localizations_zh.dart。设计统一的编辑对话框组件，支持标题、内容、标签属性修改。`review:true`

2. **[实现设置页面导航]** 创建设置页面路由和完整UI界面，实现从所有Shell的导航逻辑。影响文件：packages/ui_framework/lib/shell/app_shell.dart:301。集成基础设置功能，为主题、语言切换预留接口。`review:true`

3. **[编写Sprint 1测试套件]** 为编辑功能和设置页面导航编写全面的Widget测试和集成测试。确保所有P0修复都有测试覆盖，达到≥80%测试覆盖率。`review:true`

### Phase B: Sprint 2 (Week 2-3) - 核心服务建设与i18n重建
4. **[集成Drift数据库]** 在packages/core_services/中添加drift依赖，实现DriftPersistenceRepository替换InMemoryRepository。设计数据库表结构和迁移机制，将所有业务模块数据存储迁移到SQLite。保持IPersistenceRepository接口不变，确保向后兼容。`review:true`

5. **[重建i18n服务架构]** 重新设计AppRouter的本地化集成方案，恢复动态语言切换功能。修复packages/app_routing/lib/app_router.dart:139的i18n集成，为设置页面添加语言切换UI。支持模块级i18n扩展机制。`review:true`

6. **[修复国际化硬编码]** 移除AppRouter中的硬编码中文字符串，集成真正的国际化系统到路由层。确保所有用户界面文本支持多语言，实现完整i18n支持。`review:true`

7. **[数据库迁移工具开发]** 开发InMemory到Drift的数据迁移工具，确保现有用户数据无缝迁移。添加数据备份和恢复机制，实现现有数据100%迁移成功。`review:true`

### Phase C: Sprint 3 (Week 4) - DX工具链与高优债务偿还
8. **[建立DX工具链MVP]** 制定模块接口规范v1.0文档，开发基础的模块开发脚手架工具。创建模块开发者指南和最佳实践文档，实现模块验证和质量检查工具。确保开发者可以使用脚手架快速创建符合规范的模块。`review:true`

9. **[优化浮窗拖拽性能]** 优化packages/desktop_environment/lib/floating_window.dart的拖拽渲染性能，确保60fps帧率。实现性能监控和基准测试，添加性能回归测试。`review:true`

10. **[WindowManager抽象接口提取]** 为packages/desktop_environment/lib/window_manager.dart提取抽象接口，支持多种窗口管理策略。提高代码可测试性，实现策略模式扩展。`review:true`

11. **[质量门控和债务验证机制]** 建立技术债务自动化检测工具，实现债务偿还验证机制。确保技术债务总量从47个降至≤30个，建立新功能开发的质量门控机制。`review:true`

### Phase D: Sprint 4 - 质量保障与交付准备
12. **[全面集成测试]** 执行端到端用户流程测试，三端UI框架完整性验证。数据持久化稳定性测试，国际化功能完整性测试。确保所有核心功能100%可用。`review:true`

13. **[性能基准测试]** 应用启动时间基准测试，窗口拖拽性能验证。数据库操作性能测试，内存使用基准测试。所有性能指标达到预设基准。`review:true`

14. **[用户验证检查点]** 三端设备实际部署验证，用户体验完整性测试。功能完整性确认，反馈收集和问题修复。用户确认应用完全可用，无阻塞性问题。`review:true`

## Risk Assessment & Mitigation (Phase 2.2风险评估)

### 高风险项目
- **Sprint 1延期风险**: 编辑功能修复涉及6个文件，可能存在架构复杂性
  - **缓解策略**: 优先实现最小可用版本，复杂功能后续迭代
- **数据库迁移风险**: InMemory到Drift迁移可能导致数据丢失
  - **缓解策略**: 实现完整备份机制，分阶段迁移验证
- **i18n架构重建风险**: 可能影响现有功能稳定性
  - **缓解策略**: 保持向后兼容，渐进式替换

### 中风险项目  
- **DX工具链开发**: 需要平衡功能完整性和开发时间
  - **缓解策略**: 优先MVP版本，核心功能优先
- **性能优化**: 可能引入新的Bug
  - **缓解策略**: 充分的基准测试和回归测试

### 依赖关系
- Sprint 2依赖Sprint 1的设置页面实现
- Sprint 3的质量门控依赖前两个Sprint的债务偿还
- 所有Sprint都依赖良好的测试覆盖

## Proactive Alerts (主动风险预警)

- **[PROACTIVE_ALERT: RISK]** 如果Sprint 1延期超过2天，立即启动范围缩减
- **[PROACTIVE_ALERT: OPPORTUNITY]** Drift集成成功后，可以考虑提前实现数据导出功能
- **[PROACTIVE_ALERT: RISK]** 技术债务偿还进度需要每周跟踪，避免超出信用额度

---

# 4. Current Execution Step (Updated by EXECUTE mode at the start of each step)
> Pending: "Phase 2.2 Sprint 1 - 关键业务缺陷修复" (Review_Needed: N/A, Status: [defined] - 等待开始执行)

# 5. Task Progress (Appended by EXECUTE mode after each step's attempt/iteration and confirmation)

*Sprint执行记录将在实际开始Phase 2.2时填充*

# 6. Final Review Summary (Populated by REVIEW mode)

*Phase 2.2完成后的最终审查结果*

# 7. Retrospective/Learnings (Optional, populated by Mode 6: RETROSPECTIVE_LEARN)

*Phase 2.2完成后的经验总结和改进建议* 